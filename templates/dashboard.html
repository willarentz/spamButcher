<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpamButcher Control Center</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container py-4">
        <div class="header-panel mb-4">
            <div class="header-text">
                <p class="eyebrow">SpamButcher</p>
                <h1>Control Center</h1>
                <p class="subtext">Monitor processing, inspect classifications, and adjust the pipeline instantly.</p>
                <div class="meta-chips">
                    <span class="chip">Provider: {{ config.llm_provider|title }}</span>
                    <span class="chip">Accounts: {{ config.accounts|length }}</span>
                    <span class="chip">Worker: {{ 'Running' if worker_thread_running else 'Stopped' }}</span>
                </div>
            </div>
            <div class="header-actions">
                <div class="primary-actions">
                    <form action="{{ url_for('start_worker') }}" method="post">
                        <button class="btn btn-primary" type="submit">Start</button>
                    </form>
                    <form action="{{ url_for('stop_worker') }}" method="post">
                        <button class="btn btn-outline-primary" type="submit">Stop</button>
                    </form>
                    <form action="{{ url_for('run_once') }}" method="post">
                        <button class="btn btn-secondary" type="submit" {% if worker_thread_running %}disabled{% endif %}>Run Once</button>
                    </form>
                </div>
                <div class="secondary-actions">
                    <button class="btn btn-dark" data-toggle="modal" data-target="#configModal" type="button">Edit Configuration</button>
                    <a href="{{ url_for('manual_review') }}" class="btn btn-ghost">Manual Review</a>
                </div>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-4 w-100">
                    {% for category, message in messages %}
                        {% set mapped = 'warning' if category == 'warning' else ('danger' if category == 'error' else category) %}
                        <div class="alert alert-{{ mapped }} mb-2">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <section class="dashboard-section mb-4">
            <div class="section-header">
                <div>
                    <h2 class="mb-0">Processing Status</h2>
                    <small class="text-muted">Live health indicators for the worker loop</small>
                </div>
            </div>
            <div class="status-grid">
                <div class="status-card">
                    <div class="label">Worker Thread</div>
                    <div class="value" id="worker-thread">{{ 'Running' if worker_thread_running else 'Stopped' }}</div>
                </div>
                <div class="status-card">
                    <div class="label">Current Cycle</div>
                    <div class="value" id="cycle-status">{{ 'Processing' if status.worker_running else 'Idle' }}</div>
                </div>
                <div class="status-card small">
                    <div class="label">Last Run Start</div>
                    <div class="value" id="last-start">{{ status.last_run_start or '—' }}</div>
                </div>
                <div class="status-card small">
                    <div class="label">Last Run Finish</div>
                    <div class="value" id="last-finish">{{ status.last_run_finish or '—' }}</div>
                </div>
                <div class="status-card small">
                    <div class="label">Total Processed</div>
                    <div class="value" id="processed-total">{{ status.processed_total }}</div>
                </div>
                <div class="status-card small">
                    <div class="label">Polling Interval (sec)</div>
                    <div class="value" id="poll-interval">{{ config.poll_interval_seconds }}</div>
                </div>
                <div class="status-card small">
                    <div class="label">Last Error</div>
                    <div class="value" id="last-error">{{ status.last_error or 'None' }}</div>
                </div>
            </div>
        </section>

        

        <section class="dashboard-section mb-4">
            <div class="section-header">
                <div>
                    <h2 class="mb-0">Processed Email Log</h2>
                    <small class="text-muted">Latest entries from the database</small>
                </div>
                <div>
                    <form action="{{ url_for('clear_email_log') }}" method="post" onsubmit="return confirm('Clear all stored processed emails?');">
                        <button type="submit" class="btn btn-outline-danger">Clear Log</button>
                    </form>
                </div>
            </div>
            <div class="table-responsive dashboard-table log-table">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Date</th>
                            <th>Account</th>
                            <th>Classification</th>
                        </tr>
                    </thead>
                    <tbody id="emails-body">
                        {% for email in emails %}
                            <tr class="email-row" data-email-id="{{ email.id }}" data-account-name="{{ email.account_name }}">
                                <td>{{ email.subject or '(no subject)' }}</td>
                                <td>{{ email.from_email }}</td>
                                <td>{{ email.to_email }}</td>
                                <td>{{ email.date }}</td>
                                <td>{{ email.account_name }}</td>
                                <td>
                                    {% if email.is_spam %}
                                        <span class="badge-spam">Spam</span>
                                    {% else %}
                                        <span class="badge-ham">Ham</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="dashboard-section mb-4">
            <div class="section-header">
                <h2 class="mb-0">Event Log</h2>
                <small class="text-muted">Live processing events</small>
            </div>
            <ul class="events-list" id="event-list">
                {% for event in status.events[:10] %}
                    <li class="event-item level-{{ event.level }}">
                        <span class="time">{{ event.timestamp }}</span>
                        <span class="level">{{ event.level|upper }}</span>
                        <span class="message">{{ event.message }}</span>
                        {% if event.extra and event.extra.account %}
                            <span class="event-account">{{ event.extra.account }}</span>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </section>
    </div>

    <div class="modal fade" id="emailModal" tabindex="-1" role="dialog" aria-labelledby="emailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title" id="emailModalLabel">Email Detail</h5>
                        <small class="text-muted">Full context for the selected message.</small>
                    </div>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <dl class="email-detail-grid">
                        <div>
                            <dt>Subject</dt>
                            <dd id="detailSubject">—</dd>
                        </div>
                        <div>
                            <dt>From</dt>
                            <dd id="detailFrom">—</dd>
                        </div>
                        <div>
                            <dt>To</dt>
                            <dd id="detailTo">—</dd>
                        </div>
                        <div>
                            <dt>Date</dt>
                            <dd id="detailDate">—</dd>
                        </div>
                        <div>
                            <dt>Classification</dt>
                            <dd id="detailClassification">—</dd>
                        </div>
                        <div>
                            <dt>Account</dt>
                            <dd id="detailAccount">—</dd>
                        </div>
                        <div>
                            <dt>Message ID</dt>
                            <dd id="detailId">—</dd>
                        </div>
                    </dl>
                    <div class="email-body-wrapper">
                        <h6>Body Preview</h6>
                        <pre id="detailBody" class="email-body">Select an email to preview.</pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="mr-auto text-muted small" id="reclassify-feedback"></div>
                    <button type="button" class="btn btn-outline-primary" id="reclassify-btn">Re-evaluate</button>
                    <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade config-modal" id="configModal" tabindex="-1" role="dialog" aria-labelledby="configModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title" id="configModalLabel">Pipeline Configuration</h5>
                        <small class="text-muted">Adjust IMAP connectivity and model routing without restarting the service.</small>
                    </div>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form class="config-form" id="config-form" method="post" action="{{ url_for('update_config') }}" enctype="multipart/form-data">
                    <div class="modal-body">
                        <ul class="nav nav-tabs" id="configTabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="accounts-tab-link" data-toggle="tab" href="#accounts-tab" role="tab" aria-controls="accounts-tab" aria-selected="true">Accounts & Polling</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="llm-tab-link" data-toggle="tab" href="#llm-tab" role="tab" aria-controls="llm-tab" aria-selected="false">LLM Settings</a>
                            </li>
                        </ul>
                        <div class="tab-content p-3" id="configTabsContent">
                            <div class="tab-pane fade show active" id="accounts-tab" role="tabpanel" aria-labelledby="accounts-tab-link">
                                <p class="text-muted">Add any mix of traditional IMAP inboxes and Google Workspace / Gmail accounts. Each mailbox shares the same LLM policy.</p>
                                <input type="hidden" name="accounts-count" id="accounts-count" value="{{ config.accounts|length }}">
                                <div id="accounts-container">
                                    {% for account in config.accounts %}
                                        <div class="account-card" data-index="{{ loop.index0 }}">
                                            <div class="account-card-header">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="accounts-{{ loop.index0 }}-enabled" name="accounts-{{ loop.index0 }}-enabled" data-field="enabled" {% if account.enabled %}checked{% endif %}>
                                                    <label class="form-check-label" for="accounts-{{ loop.index0 }}-enabled">Enabled</label>
                                                </div>
                                                {% if config.accounts|length > 1 %}
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-account">Remove</button>
                                                {% endif %}
                                            </div>
                                            {% set acct_type = (account.type or 'imap') %}
                                            <div class="form-row">
                                                <div class="form-group col-md-4">
                                                    <label>Label</label>
                                                    <input type="text" class="form-control" name="accounts-{{ loop.index0 }}-name" data-field="name" value="{{ account.name }}" placeholder="Marketing Inbox">
                                                </div>
                                                <div class="form-group col-md-3">
                                                    <label>Account Type</label>
                                                    <select class="form-control account-type-select" name="accounts-{{ loop.index0 }}-type" data-field="type">
                                                        <option value="imap" {% if acct_type != 'google' %}selected{% endif %}>IMAP</option>
                                                        <option value="google" {% if acct_type == 'google' %}selected{% endif %}>Google</option>
                                                    </select>
                                                </div>
                                                <div class="form-group col-md-3">
                                                    <label>Spam Folder / Label</label>
                                                    <input type="text" class="form-control" name="accounts-{{ loop.index0 }}-spam_folder" data-field="spam_folder" value="{{ account.spam_folder }}" placeholder="SpamAI">
                                                </div>
                                                <div class="form-group col-md-2">
                                                    <label>Max/Cycle</label>
                                                    <input type="number" min="1" class="form-control" name="accounts-{{ loop.index0 }}-download_max" data-field="download_max" value="{{ account.download_max }}">
                                                </div>
                                            </div>
                                            <div class="account-type-section {% if acct_type == 'google' %}d-none{% endif %}" data-type-section="imap">
                                                <div class="form-row">
                                                    <div class="form-group col-md-4">
                                                        <label>IMAP Host</label>
                                                        <input type="text" class="form-control" name="accounts-{{ loop.index0 }}-imap_host" data-field="imap_host" value="{{ account.imap_host }}" autocapitalize="none" spellcheck="false">
                                                    </div>
                                                    <div class="form-group col-md-4">
                                                        <label>Username</label>
                                                        <input type="text" class="form-control" name="accounts-{{ loop.index0 }}-imap_username" data-field="imap_username" value="{{ account.imap_username }}" autocapitalize="none" spellcheck="false">
                                                    </div>
                                                    <div class="form-group col-md-4">
                                                        <label>Password / App Password</label>
                                                        <input type="password" class="form-control" name="accounts-{{ loop.index0 }}-imap_password" data-field="imap_password" value="{{ account.imap_password }}" autocapitalize="none">
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label>Inbox Folder</label>
                                                    <input type="text" class="form-control" name="accounts-{{ loop.index0 }}-imap_folder" data-field="imap_folder" value="{{ account.imap_folder or 'INBOX' }}">
                                                </div>
                                            </div>
                                            <div class="account-type-section {% if acct_type != 'google' %}d-none{% endif %}" data-type-section="google">
                                                <input type="hidden" name="accounts-{{ loop.index0 }}-google_credentials_file" data-field="google_credentials_file" value="{{ account.google_credentials_file }}">
                                                <input type="hidden" name="accounts-{{ loop.index0 }}-google_token_file" data-field="google_token_file" value="{{ account.google_token_file }}">
                                                <div class="form-group">
                                                    <label>OAuth Client JSON</label>
                                                    <div class="credential-status text-muted mb-2">
                                                        {% if account.google_credentials_file %}
                                                            Credential stored in app sandbox.
                                                        {% else %}
                                                            No credential uploaded yet.
                                                        {% endif %}
                                                    </div>
                                                    <textarea class="form-control" rows="4" name="accounts-{{ loop.index0 }}-google_credentials_data" data-field="google_credentials_data" placeholder="Paste the full OAuth client JSON blob here"></textarea>
                                                    <small class="form-text text-muted">Prefer not to paste? Upload the JSON file below.</small>
                                                </div>
                                                <div class="form-group">
                                                    <label>Google Redirect URL</label>
                                                    <div class="auto-token-hint">
                                                        <p class="mb-1"><code>{{ google_callback_url }}</code></p>
                                                        <small class="text-muted">Add this exact URL to the OAuth client's Authorized redirect URIs in Google Cloud.</small>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label>Upload OAuth JSON</label>
                                                    <input type="file" class="form-control-file" name="accounts-{{ loop.index0 }}-google_credentials_upload" data-field="google_credentials_upload" accept=".json,.JSON,application/json,text/json,application/x-json,application/octet-stream">
                                                    <small class="form-text text-muted">SpamButcher will copy the file into its secure storage.</small>
                                                </div>
                                                <div class="form-group">
                                                    <label>Authorize SpamButcher</label>
                                                    {% if account.google_credentials_file %}
                                                        <div class="oauth-action-row">
                                                            <a class="btn btn-outline-primary btn-sm" target="_blank" href="{{ url_for('google_oauth_start', account_index=loop.index0) }}">Open Google Consent</a>
                                                            {% if account.google_token_file %}
                                                                <span class="credential-status text-success">Token stored.</span>
                                                            {% endif %}
                                                        </div>
                                                        <small class="form-text text-muted">Opens a Google consent window. Approve access, then return here.</small>
                                                    {% else %}
                                                        <div>
                                                            <button type="button" class="btn btn-outline-secondary btn-sm" disabled>Open Google Consent</button>
                                                            <small class="form-text text-muted">Paste or upload credentials, save, then authorize.</small>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="form-group">
                                                    <label>Token Handling</label>
                                                    <div class="auto-token-hint">
                                                        <p class="mb-1">Tokens are stored automatically — no manual file paths required.</p>
                                                        <small class="text-muted">Saving with new credentials resets the token so Gmail OAuth can run again.</small>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label>Unread Query</label>
                                                    <input type="text" class="form-control" name="accounts-{{ loop.index0 }}-google_query" data-field="google_query" value="{{ account.google_query }}" placeholder="label:INBOX is:unread">
                                                    <small class="form-text text-muted">Uses Gmail search syntax; defaults to all unread inbox messages.</small>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-outline-primary mt-3" id="add-account-btn">Add Account</button>
                                <div class="form-row mt-3">
                                    <div class="form-group col-md-4">
                                        <label for="poll_interval_seconds">Poll Interval (seconds)</label>
                                        <input type="number" min="30" class="form-control" id="poll_interval_seconds" name="poll_interval_seconds" value="{{ config.poll_interval_seconds }}">
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="llm-tab" role="tabpanel" aria-labelledby="llm-tab-link">
                                <fieldset>
                                    <legend class="sr-only">LLM Provider</legend>
                                    <div class="form-row">
                                        <div class="form-group col-md-4">
                                            <label for="llm_provider">Provider</label>
                                            <select class="form-control" id="llm_provider" name="llm_provider">
                                                <option value="ollama" {% if config.llm_provider == 'ollama' %}selected{% endif %}>Ollama</option>
                                                <option value="openai" {% if config.llm_provider == 'openai' %}selected{% endif %}>OpenAI</option>
                                                <option value="gemini" {% if config.llm_provider == 'gemini' %}selected{% endif %}>Gemini</option>
                                            </select>
                                        </div>
                                        <div class="form-group col-md-8">
                                            <label for="system_prompt">System Prompt</label>
                                            <textarea class="form-control" id="system_prompt" rows="3" name="system_prompt">{{ config.system_prompt }}</textarea>
                                        </div>
                                    </div>
                                    <div class="provider-section {% if config.llm_provider != 'ollama' %}d-none{% endif %}" data-provider="ollama">
                                        <h5>Ollama Settings</h5>
                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label for="ollama_base_url">Base URL</label>
                                                <input type="text" class="form-control" id="ollama_base_url" name="ollama_base_url" value="{{ config.ollama.base_url }}">
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label for="ollama_model">Model</label>
                                                <select class="form-control" id="ollama_model" name="ollama_model" data-current-value="{{ config.ollama.model }}">
                                                    {% if config.ollama.model %}
                                                        <option value="{{ config.ollama.model }}" selected>{{ config.ollama.model }}</option>
                                                    {% else %}
                                                        <option value="" disabled selected>Loading models…</option>
                                                    {% endif %}
                                                </select>
                                                <small class="form-text text-muted" id="ollama-model-feedback"></small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="provider-section {% if config.llm_provider != 'openai' %}d-none{% endif %}" data-provider="openai">
                                        <h5>OpenAI Settings</h5>
                                        <div class="form-row">
                                            <div class="form-group col-md-4">
                                                <label for="openai_base_url">Base URL</label>
                                                <input type="text" class="form-control" id="openai_base_url" name="openai_base_url" value="{{ config.openai.base_url }}">
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label for="openai_model">Model</label>
                                                <input type="text" class="form-control" id="openai_model" name="openai_model" value="{{ config.openai.model }}">
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label for="openai_api_key">API Key</label>
                                                <input type="password" class="form-control" id="openai_api_key" name="openai_api_key" value="{{ config.openai.api_key }}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="provider-section {% if config.llm_provider != 'gemini' %}d-none{% endif %}" data-provider="gemini">
                                        <h5>Gemini Settings</h5>
                                        <div class="form-row">
                                            <div class="form-group col-md-4">
                                                <label for="gemini_base_url">Base URL</label>
                                                <input type="text" class="form-control" id="gemini_base_url" name="gemini_base_url" value="{{ config.gemini.base_url }}">
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label for="gemini_model">Model</label>
                                                <input type="text" class="form-control" id="gemini_model" name="gemini_model" value="{{ config.gemini.model }}">
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label for="gemini_api_key">API Key</label>
                                                <input type="password" class="form-control" id="gemini_api_key" name="gemini_api_key" value="{{ config.gemini.api_key }}">
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <template id="account-template">
        <div class="account-card" data-index="__INDEX__">
            <div class="account-card-header">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" data-field="enabled">
                    <label class="form-check-label">Enabled</label>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger remove-account">Remove</button>
            </div>
            <div class="form-row">
                <div class="form-group col-md-4">
                    <label>Label</label>
                    <input type="text" class="form-control" data-field="name" placeholder="Support">
                </div>
                <div class="form-group col-md-3">
                    <label>Account Type</label>
                    <select class="form-control account-type-select" data-field="type">
                        <option value="imap" selected>IMAP</option>
                        <option value="google">Google</option>
                    </select>
                </div>
                <div class="form-group col-md-3">
                    <label>Spam Folder / Label</label>
                    <input type="text" class="form-control" data-field="spam_folder" value="SpamAI">
                </div>
                <div class="form-group col-md-2">
                    <label>Max/Cycle</label>
                    <input type="number" min="1" class="form-control" data-field="download_max" value="50">
                </div>
            </div>
            <div class="account-type-section" data-type-section="imap">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label>IMAP Host</label>
                        <input type="text" class="form-control" data-field="imap_host" autocapitalize="none" spellcheck="false">
                    </div>
                    <div class="form-group col-md-4">
                        <label>Username</label>
                        <input type="text" class="form-control" data-field="imap_username" autocapitalize="none" spellcheck="false">
                    </div>
                    <div class="form-group col-md-4">
                        <label>Password / App Password</label>
                        <input type="password" class="form-control" data-field="imap_password" autocapitalize="none">
                    </div>
                </div>
                <div class="form-group">
                    <label>Inbox Folder</label>
                    <input type="text" class="form-control" data-field="imap_folder" value="INBOX">
                </div>
            </div>
            <div class="account-type-section d-none" data-type-section="google">
                <input type="hidden" data-field="google_credentials_file">
                <input type="hidden" data-field="google_token_file">
                <div class="form-group">
                    <label>OAuth Client JSON</label>
                    <textarea class="form-control" rows="4" data-field="google_credentials_data" placeholder="Paste the OAuth client JSON here"></textarea>
                    <small class="form-text text-muted">Prefer to upload? Use the file picker below.</small>
                </div>
                <div class="form-group">
                    <label>Google Redirect URL</label>
                    <div class="auto-token-hint">
                        <p class="mb-1"><code>{{ google_callback_url }}</code></p>
                        <small class="text-muted">Add this URL to the OAuth client's Authorized redirect URIs before saving.</small>
                    </div>
                </div>
                <div class="form-group">
                    <label>Upload OAuth JSON</label>
                    <input type="file" class="form-control-file" data-field="google_credentials_upload" accept=".json,.JSON,application/json,text/json,application/x-json,application/octet-stream">
                    <small class="form-text text-muted">SpamButcher will copy the file into secure storage.</small>
                </div>
                <div class="form-group">
                    <label>Authorize SpamButcher</label>
                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled>Open Google Consent</button>
                    <small class="form-text text-muted">Save this account first, then use the button in the dashboard to authorize.</small>
                </div>
                <div class="form-group">
                    <label>Token Handling</label>
                    <div class="auto-token-hint">
                        <p class="mb-1">Tokens are stored automatically once the OAuth flow completes.</p>
                        <small class="text-muted">No manual file paths are needed.</small>
                    </div>
                </div>
                <div class="form-group">
                    <label>Unread Query</label>
                    <input type="text" class="form-control" data-field="google_query" value="label:INBOX is:unread">
                    <small class="form-text text-muted">Uses Gmail search syntax; defaults to all unread inbox messages.</small>
                </div>
            </div>
        </div>
    </template>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        const statusEndpoint = "{{ url_for('api_status') }}";
        const emailsEndpoint = "{{ url_for('api_emails') }}";
        const ollamaModelsEndpoint = "{{ url_for('api_ollama_models') }}";
        const statusState = {{ status|tojson }};
        const emailsState = {{ emails|tojson }};
        const reclassifyBtn = document.getElementById('reclassify-btn');
        const reclassifyFeedback = document.getElementById('reclassify-feedback');
        const activeEmail = { id: null, account: null };

        function escapeHtml(unsafe) {
            if (!unsafe && unsafe !== 0) {
                return '';
            }
            return String(unsafe)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function toDisplayTime(value) {
            if (!value) {
                return '—';
            }
            const date = new Date(value);
            if (isNaN(date.getTime())) {
                return value;
            }
            return date.toLocaleString();
        }

        function renderStatus(data) {
            document.getElementById('worker-thread').textContent = data.worker_thread_running ? 'Running' : 'Stopped';
            document.getElementById('cycle-status').textContent = data.worker_running ? 'Processing' : 'Idle';
            document.getElementById('last-start').textContent = toDisplayTime(data.last_run_start);
            document.getElementById('last-finish').textContent = toDisplayTime(data.last_run_finish);
            document.getElementById('processed-total').textContent = data.processed_total || 0;
            document.getElementById('poll-interval').textContent = data.poll_interval_seconds || 0;
            document.getElementById('last-error').textContent = data.last_error || 'None';
            renderEvents(data.events || []);
        }

        function renderEmails(emails) {
            const tbody = document.getElementById('emails-body');
            tbody.innerHTML = '';
            emails.forEach((item) => {
                const row = document.createElement('tr');
                row.className = 'email-row';
                row.dataset.emailId = item.id;
                row.dataset.accountName = item.account_name || '';
                const classification = item.is_spam ? '<span class="badge-spam">Spam</span>' : '<span class="badge-ham">Ham</span>';
                row.innerHTML = `
                    <td>${escapeHtml(item.subject || '(no subject)')}</td>
                    <td>${escapeHtml(item.from_email || '')}</td>
                    <td>${escapeHtml(item.to_email || '')}</td>
                    <td>${escapeHtml(item.date || '')}</td>
                    <td>${escapeHtml(item.account_name || '')}</td>
                    <td>${classification}</td>
                `;
                row.addEventListener('click', () => openEmailModal(item.id, item.account_name));
                tbody.appendChild(row);
            });
        }

        function renderEvents(events) {
            const list = document.getElementById('event-list');
            list.innerHTML = '';
            events.slice(0, 10).forEach((event) => {
                const item = document.createElement('li');
                item.className = `event-item level-${event.level}`;
                const accountLabel = event.extra && event.extra.account ? `<span class="event-account">${escapeHtml(event.extra.account)}</span>` : '';
                item.innerHTML = `
                    <span class="time">${escapeHtml(toDisplayTime(event.timestamp))}</span>
                    <span class="level">${escapeHtml(event.level ? event.level.toUpperCase() : '')}</span>
                    <span class="message">${escapeHtml(event.message || '')}</span>
                    ${accountLabel}
                `;
                list.appendChild(item);
            });
        }

        function refreshData() {
            fetch(statusEndpoint)
                .then((response) => response.json())
                .then((data) => renderStatus(data))
                .catch(() => {});
            fetch(`${emailsEndpoint}?limit=25`)
                .then((response) => response.json())
                .then((data) => renderEmails(data))
                .catch(() => {});
        }

        function setupProviderSections() {
            const select = document.getElementById('llm_provider');
            if (!select) {
                return;
            }
            const toggleSections = () => {
                document.querySelectorAll('.provider-section').forEach((section) => {
                    section.classList.toggle('d-none', section.dataset.provider !== select.value);
                });
            };
            select.addEventListener('change', toggleSections);
            toggleSections();
        }

        const ollamaModelSelect = document.getElementById('ollama_model');
        const ollamaModelFeedback = document.getElementById('ollama-model-feedback');
        const ollamaBaseUrlInput = document.getElementById('ollama_base_url');
        const initialOllamaModelValue = ollamaModelSelect
            ? (ollamaModelSelect.dataset.current_value || ollamaModelSelect.dataset.currentValue || ollamaModelSelect.value || '')
            : '';
        let ollamaModelsRequestId = 0;
        let savedOllamaModel = initialOllamaModelValue;

        function renderOllamaModelOptions(models, placeholderText, disableSelect = false) {
            if (!ollamaModelSelect) {
                return;
            }
            const uniqueModels = [];
            const seen = new Set();
            (models || []).forEach((model) => {
                if (typeof model !== 'string' || seen.has(model)) {
                    return;
                }
                seen.add(model);
                uniqueModels.push(model);
            });
            const preferred = savedOllamaModel || '';
            ollamaModelSelect.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.disabled = true;
            placeholder.textContent =
                placeholderText || (uniqueModels.length ? 'Select a model' : 'No models detected');
            if (uniqueModels.length === 0) {
                placeholder.selected = true;
            }
            ollamaModelSelect.appendChild(placeholder);
            uniqueModels.forEach((model) => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                ollamaModelSelect.appendChild(option);
            });
            if (uniqueModels.length > 0) {
                if (preferred && seen.has(preferred)) {
                    ollamaModelSelect.value = preferred;
                    savedOllamaModel = preferred;
                } else {
                    ollamaModelSelect.value = uniqueModels[0];
                    savedOllamaModel = uniqueModels[0];
                }
            } else {
                savedOllamaModel = '';
            }
            const disable = disableSelect || uniqueModels.length === 0;
            ollamaModelSelect.disabled = disable;
        }

        function loadOllamaModels() {
            if (!ollamaBaseUrlInput) {
                return;
            }
            const baseUrl = ollamaBaseUrlInput.value.trim();
            if (!baseUrl) {
                renderOllamaModelOptions([], 'Enter a base URL to load models', true);
                if (ollamaModelFeedback) {
                    ollamaModelFeedback.textContent = 'Enter a base URL to load models';
                }
                return;
            }
            const params = new URLSearchParams();
            params.set('base_url', baseUrl);
            const requestId = ++ollamaModelsRequestId;
            if (ollamaModelFeedback) {
                ollamaModelFeedback.textContent = 'Loading models…';
            }
            fetch(`${ollamaModelsEndpoint}?${params.toString()}`)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Failed to load models');
                    }
                    return response.json();
                })
                .then((data) => {
                    if (requestId !== ollamaModelsRequestId) {
                        return;
                    }
                    const models = Array.isArray(data.models) ? data.models : [];
                    renderOllamaModelOptions(models);
                    if (ollamaModelFeedback) {
                        if (models.length > 0) {
                            const plural = models.length === 1 ? '' : 's';
                            ollamaModelFeedback.textContent = `${models.length} model${plural} detected`;
                        } else if (data.error) {
                            ollamaModelFeedback.textContent = 'Unable to load models';
                        } else {
                            ollamaModelFeedback.textContent = 'No models found on this Ollama host';
                        }
                    }
                })
                .catch(() => {
                    if (requestId !== ollamaModelsRequestId) {
                        return;
                    }
                    renderOllamaModelOptions([], 'Unable to load models', true);
                    if (ollamaModelFeedback) {
                        ollamaModelFeedback.textContent = 'Unable to load models';
                    }
                });
        }

        const accountsContainer = document.getElementById('accounts-container');
        const accountTemplate = document.getElementById('account-template');
        const addAccountBtn = document.getElementById('add-account-btn');
        const accountsCountInput = document.getElementById('accounts-count');

        function toggleAccountSectionsForCard(card, typeValue) {
            if (!card) {
                return;
            }
            const normalized = (typeValue || 'imap').toLowerCase();
            card.querySelectorAll('[data-type-section]').forEach((section) => {
                const sectionType = section.dataset.typeSection || 'imap';
                section.classList.toggle('d-none', sectionType !== normalized);
            });
        }

        function refreshAccountTypeSections() {
            if (!accountsContainer) {
                return;
            }
            accountsContainer.querySelectorAll('.account-card').forEach((card) => {
                const select = card.querySelector('[data-field="type"]');
                toggleAccountSectionsForCard(card, select ? select.value : 'imap');
            });
        }

        function refreshAccountIndices() {
            const cards = accountsContainer ? accountsContainer.querySelectorAll('.account-card') : [];
            cards.forEach((card, idx) => {
                card.dataset.index = idx;
                card.querySelectorAll('[data-field]').forEach((input) => {
                    const field = input.dataset.field;
                    const name = `accounts-${idx}-${field}`;
                    input.name = name;
                    if (input.id && input.id.startsWith('accounts-')) {
                        input.id = name;
                    }
                });
            });
            if (accountsCountInput) {
                accountsCountInput.value = cards.length;
            }
            refreshAccountTypeSections();
        }

        function addAccountCard() {
            if (!accountTemplate || !accountsContainer) {
                return;
            }
            const fragment = accountTemplate.content.cloneNode(true);
            accountsContainer.appendChild(fragment);
            refreshAccountIndices();
        }

        if (addAccountBtn) {
            addAccountBtn.addEventListener('click', (event) => {
                event.preventDefault();
                addAccountCard();
            });
        }

        if (accountsContainer) {
            accountsContainer.addEventListener('click', (event) => {
                if (event.target.closest('.remove-account')) {
                    event.preventDefault();
                    const card = event.target.closest('.account-card');
                    if (card) {
                        card.remove();
                        refreshAccountIndices();
                    }
                }
            });
            accountsContainer.addEventListener('change', (event) => {
                const select = event.target.closest('[data-field="type"]');
                if (!select) {
                    return;
                }
                const card = event.target.closest('.account-card');
                toggleAccountSectionsForCard(card, select.value);
            });
        }

        if (ollamaBaseUrlInput) {
            ['change', 'blur'].forEach((eventName) => {
                ollamaBaseUrlInput.addEventListener(eventName, loadOllamaModels);
            });
        }
        if (ollamaModelSelect) {
            ollamaModelSelect.addEventListener('change', () => {
                savedOllamaModel = ollamaModelSelect.value || '';
            });
        }
        if (window.jQuery) {
            $('#configModal').on('shown.bs.modal', () => loadOllamaModels());
        }

        const configForm = document.getElementById('config-form');
        if (configForm) {
            configForm.addEventListener('submit', () => refreshAccountIndices());
        }

        renderStatus(statusState);
        renderEmails(emailsState);
        renderEvents(statusState.events || []);
        setupProviderSections();
        loadOllamaModels();
        refreshAccountIndices();
        setInterval(refreshData, 5000);

        function setReclassifyFeedback(message, isError = false) {
            if (!reclassifyFeedback) {
                return;
            }
            reclassifyFeedback.textContent = message || '';
            reclassifyFeedback.classList.toggle('text-danger', isError);
            reclassifyFeedback.classList.toggle('text-muted', !isError);
        }

        function setReclassifyState(isLoading) {
            if (!reclassifyBtn) {
                return;
            }
            reclassifyBtn.disabled = isLoading || !activeEmail.id;
            reclassifyBtn.textContent = isLoading ? 'Re-evaluating...' : 'Re-evaluate';
        }

        function setDetailField(id, value, allowHtml = false) {
            const el = document.getElementById(id);
            if (!el) {
                return;
            }
            if (allowHtml) {
                el.innerHTML = value;
            } else {
                el.textContent = value;
            }
        }

        function classifyBadge(isSpam) {
            const label = isSpam ? 'Spam' : 'Ham';
            const cls = isSpam ? 'badge-spam' : 'badge-ham';
            return `<span class="${cls}">${label}</span>`;
        }

        function openEmailModal(emailId, accountName) {
            activeEmail.id = emailId;
            activeEmail.account = accountName || null;
            setReclassifyFeedback('');
            setReclassifyState(false);
            setDetailField('detailSubject', 'Loading...');
            setDetailField('detailFrom', 'Loading...');
            setDetailField('detailTo', 'Loading...');
            setDetailField('detailDate', 'Loading...');
            setDetailField('detailClassification', 'Loading...');
            setDetailField('detailAccount', accountName || 'Loading...');
            setDetailField('detailId', escapeHtml(emailId));
            document.getElementById('detailBody').textContent = 'Loading email body...';
            $('#emailModal').modal('show');
            const accountParam = accountName ? `?account=${encodeURIComponent(accountName)}` : '';
            fetch(`${emailsEndpoint}/${encodeURIComponent(emailId)}${accountParam}`)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Unable to load email detail');
                    }
                    return response.json();
                })
                .then((data) => {
                    setDetailField('detailSubject', data.subject || '(no subject)');
                    setDetailField('detailFrom', data.from_email || '');
                    setDetailField('detailTo', data.to_email || '');
                    setDetailField('detailDate', data.date || '');
                    setDetailField('detailClassification', classifyBadge(Boolean(data.is_spam)), true);
                    setDetailField('detailAccount', data.account_name || accountName || '');
                    setDetailField('detailId', data.id || emailId);
                    const body = data.plain_text_body || data.html_body || '(no body)';
                    document.getElementById('detailBody').textContent = body;
                })
                .catch(() => {
                    document.getElementById('detailBody').textContent = 'Unable to load email details.';
                    setDetailField('detailClassification', '<span class="text-danger">Error</span>', true);
                    setDetailField('detailAccount', accountName || 'Unknown');
                });
        }

        if (reclassifyBtn) {
            reclassifyBtn.addEventListener('click', () => {
                if (!activeEmail.id) {
                    return;
                }
                setReclassifyState(true);
                setReclassifyFeedback('Re-evaluating with current LLM...');
                fetch(`${emailsEndpoint}/${encodeURIComponent(activeEmail.id)}/reclassify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account: activeEmail.account }),
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error('Unable to re-evaluate');
                        }
                        return response.json();
                    })
                    .then((data) => {
                        const isSpam = Boolean(data.is_spam);
                        setDetailField('detailClassification', classifyBadge(isSpam), true);
                        const same = data.previous_is_spam === isSpam;
                        const message = same ? 'Classification confirmed.' : 'Classification updated.';
                        setReclassifyFeedback(message);
                        setDetailField('detailAccount', data.account_name || activeEmail.account || '');
                        refreshData();
                    })
                    .catch(() => {
                        setReclassifyFeedback('Re-evaluation failed.', true);
                    })
                    .finally(() => {
                        setReclassifyState(false);
                    });
            });
            setReclassifyState(false);
        }
    </script>
</body>
</html>
