<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpamButcher Control Center</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container py-4">
        <div class="header-panel mb-4">
            <div class="header-text">
                <p class="eyebrow">SpamButcher</p>
                <h1>Control Center</h1>
                <p class="subtext">Monitor processing, inspect classifications, and adjust the pipeline instantly.</p>
                <div class="meta-chips">
                    <span class="chip">Provider: {{ config.llm_provider|title }}</span>
                    <span class="chip">Spam folder: {{ config.spam_folder }}</span>
                    <span class="chip">Worker: {{ 'Running' if worker_thread_running else 'Stopped' }}</span>
                </div>
            </div>
            <div class="header-actions">
                <div class="primary-actions">
                    <form action="{{ url_for('start_worker') }}" method="post">
                        <button class="btn btn-primary" type="submit">Start</button>
                    </form>
                    <form action="{{ url_for('stop_worker') }}" method="post">
                        <button class="btn btn-outline-primary" type="submit">Stop</button>
                    </form>
                    <form action="{{ url_for('run_once') }}" method="post">
                        <button class="btn btn-secondary" type="submit" {% if worker_thread_running %}disabled{% endif %}>Run Once</button>
                    </form>
                </div>
                <div class="secondary-actions">
                    <button class="btn btn-dark" data-toggle="modal" data-target="#configModal" type="button">Edit Configuration</button>
                    <a href="{{ url_for('manual_review') }}" class="btn btn-ghost">Manual Review</a>
                </div>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-4 w-100">
                    {% for category, message in messages %}
                        {% set mapped = 'warning' if category == 'warning' else ('danger' if category == 'error' else category) %}
                        <div class="alert alert-{{ mapped }} mb-2">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <section class="dashboard-section mb-4">
            <div class="section-header">
                <div>
                    <h2 class="mb-0">Processing Status</h2>
                    <small class="text-muted">Live health indicators for the worker loop</small>
                </div>
            </div>
            <div class="status-grid">
                <div class="status-card">
                    <div class="label">Worker Thread</div>
                    <div class="value" id="worker-thread">{{ 'Running' if worker_thread_running else 'Stopped' }}</div>
                </div>
                <div class="status-card">
                    <div class="label">Current Cycle</div>
                    <div class="value" id="cycle-status">{{ 'Processing' if status.worker_running else 'Idle' }}</div>
                </div>
                <div class="status-card small">
                    <div class="label">Last Run Start</div>
                    <div class="value" id="last-start">{{ status.last_run_start or '—' }}</div>
                </div>
                <div class="status-card small">
                    <div class="label">Last Run Finish</div>
                    <div class="value" id="last-finish">{{ status.last_run_finish or '—' }}</div>
                </div>
                <div class="status-card small">
                    <div class="label">Total Processed</div>
                    <div class="value" id="processed-total">{{ status.processed_total }}</div>
                </div>
                <div class="status-card small">
                    <div class="label">Polling Interval (sec)</div>
                    <div class="value" id="poll-interval">{{ config.poll_interval_seconds }}</div>
                </div>
                <div class="status-card small">
                    <div class="label">Last Error</div>
                    <div class="value" id="last-error">{{ status.last_error or 'None' }}</div>
                </div>
            </div>
        </section>

        

        <section class="dashboard-section mb-4">
            <div class="section-header">
                <div>
                    <h2 class="mb-0">Processed Email Log</h2>
                    <small class="text-muted">Latest entries from the database</small>
                </div>
                <div>
                    <form action="{{ url_for('clear_email_log') }}" method="post" onsubmit="return confirm('Clear all stored processed emails?');">
                        <button type="submit" class="btn btn-outline-danger">Clear Log</button>
                    </form>
                </div>
            </div>
            <div class="table-responsive dashboard-table log-table">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Date</th>
                            <th>Classification</th>
                        </tr>
                    </thead>
                    <tbody id="emails-body">
                        {% for email in emails %}
                            <tr class="email-row" data-email-id="{{ email.id }}">
                                <td>{{ email.subject or '(no subject)' }}</td>
                                <td>{{ email.from_email }}</td>
                                <td>{{ email.to_email }}</td>
                                <td>{{ email.date }}</td>
                                <td>
                                    {% if email.is_spam %}
                                        <span class="badge-spam">Spam</span>
                                    {% else %}
                                        <span class="badge-ham">Ham</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="dashboard-section mb-4">
            <div class="section-header">
                <h2 class="mb-0">Event Log</h2>
                <small class="text-muted">Live processing events</small>
            </div>
            <ul class="events-list" id="event-list">
                {% for event in status.events[:10] %}
                    <li class="event-item level-{{ event.level }}">
                        <span class="time">{{ event.timestamp }}</span>
                        <span class="level">{{ event.level|upper }}</span>
                        <span class="message">{{ event.message }}</span>
                    </li>
                {% endfor %}
            </ul>
        </section>
    </div>

    <div class="modal fade" id="emailModal" tabindex="-1" role="dialog" aria-labelledby="emailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title" id="emailModalLabel">Email Detail</h5>
                        <small class="text-muted">Full context for the selected message.</small>
                    </div>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <dl class="email-detail-grid">
                        <div>
                            <dt>Subject</dt>
                            <dd id="detailSubject">—</dd>
                        </div>
                        <div>
                            <dt>From</dt>
                            <dd id="detailFrom">—</dd>
                        </div>
                        <div>
                            <dt>To</dt>
                            <dd id="detailTo">—</dd>
                        </div>
                        <div>
                            <dt>Date</dt>
                            <dd id="detailDate">—</dd>
                        </div>
                        <div>
                            <dt>Classification</dt>
                            <dd id="detailClassification">—</dd>
                        </div>
                        <div>
                            <dt>Message ID</dt>
                            <dd id="detailId">—</dd>
                        </div>
                    </dl>
                    <div class="email-body-wrapper">
                        <h6>Body Preview</h6>
                        <pre id="detailBody" class="email-body">Select an email to preview.</pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="configModal" tabindex="-1" role="dialog" aria-labelledby="configModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title" id="configModalLabel">Pipeline Configuration</h5>
                        <small class="text-muted">Adjust IMAP connectivity and model routing without restarting the service.</small>
                    </div>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form class="config-form" method="post" action="{{ url_for('update_config') }}">
                    <div class="modal-body">
                        <fieldset>
                            <legend>IMAP Settings</legend>
                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label for="imap_host">IMAP Host</label>
                                    <input type="text" class="form-control" id="imap_host" name="imap_host" value="{{ config.imap_host }}" required autocapitalize="none" spellcheck="false">
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="imap_username">Username</label>
                                    <input type="text" class="form-control" id="imap_username" name="imap_username" value="{{ config.imap_username }}" required autocapitalize="none" spellcheck="false">
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="imap_password">Password</label>
                                    <input type="password" class="form-control" id="imap_password" name="imap_password" value="{{ config.imap_password }}" required autocapitalize="none">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-3">
                                    <label for="imap_folder">Inbox Folder</label>
                                    <input type="text" class="form-control" id="imap_folder" name="imap_folder" value="{{ config.imap_folder }}">
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="spam_folder">Spam Folder</label>
                                    <input type="text" class="form-control" id="spam_folder" name="spam_folder" value="{{ config.spam_folder }}">
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="download_max">Max Emails Per Cycle</label>
                                    <input type="number" min="1" class="form-control" id="download_max" name="download_max" value="{{ config.download_max }}">
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="poll_interval_seconds">Poll Interval (sec)</label>
                                    <input type="number" min="30" class="form-control" id="poll_interval_seconds" name="poll_interval_seconds" value="{{ config.poll_interval_seconds }}">
                                </div>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend>LLM Provider</legend>
                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label for="llm_provider">Provider</label>
                                    <select class="form-control" id="llm_provider" name="llm_provider">
                                        <option value="ollama" {% if config.llm_provider == 'ollama' %}selected{% endif %}>Ollama</option>
                                        <option value="openai" {% if config.llm_provider == 'openai' %}selected{% endif %}>OpenAI</option>
                                        <option value="gemini" {% if config.llm_provider == 'gemini' %}selected{% endif %}>Gemini</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-8">
                                    <label for="system_prompt">System Prompt</label>
                                    <textarea class="form-control" id="system_prompt" rows="3" name="system_prompt">{{ config.system_prompt }}</textarea>
                                </div>
                            </div>
                            <div class="provider-section {% if config.llm_provider != 'ollama' %}d-none{% endif %}" data-provider="ollama">
                                <h5>Ollama Settings</h5>
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="ollama_base_url">Base URL</label>
                                        <input type="text" class="form-control" id="ollama_base_url" name="ollama_base_url" value="{{ config.ollama.base_url }}">
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="ollama_model">Model</label>
                                        <input type="text" class="form-control" id="ollama_model" name="ollama_model" value="{{ config.ollama.model }}">
                                    </div>
                                </div>
                            </div>
                            <div class="provider-section {% if config.llm_provider != 'openai' %}d-none{% endif %}" data-provider="openai">
                                <h5>OpenAI Settings</h5>
                                <div class="form-row">
                                    <div class="form-group col-md-4">
                                        <label for="openai_base_url">Base URL</label>
                                        <input type="text" class="form-control" id="openai_base_url" name="openai_base_url" value="{{ config.openai.base_url }}">
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="openai_model">Model</label>
                                        <input type="text" class="form-control" id="openai_model" name="openai_model" value="{{ config.openai.model }}">
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="openai_api_key">API Key</label>
                                        <input type="password" class="form-control" id="openai_api_key" name="openai_api_key" value="{{ config.openai.api_key }}">
                                    </div>
                                </div>
                            </div>
                            <div class="provider-section {% if config.llm_provider != 'gemini' %}d-none{% endif %}" data-provider="gemini">
                                <h5>Gemini Settings</h5>
                                <div class="form-row">
                                    <div class="form-group col-md-4">
                                        <label for="gemini_base_url">Base URL</label>
                                        <input type="text" class="form-control" id="gemini_base_url" name="gemini_base_url" value="{{ config.gemini.base_url }}">
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="gemini_model">Model</label>
                                        <input type="text" class="form-control" id="gemini_model" name="gemini_model" value="{{ config.gemini.model }}">
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="gemini_api_key">API Key</label>
                                        <input type="password" class="form-control" id="gemini_api_key" name="gemini_api_key" value="{{ config.gemini.api_key }}">
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        const statusEndpoint = "{{ url_for('api_status') }}";
        const emailsEndpoint = "{{ url_for('api_emails') }}";
        const statusState = {{ status|tojson }};
        const emailsState = {{ emails|tojson }};

        function escapeHtml(unsafe) {
            if (!unsafe && unsafe !== 0) {
                return '';
            }
            return String(unsafe)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function toDisplayTime(value) {
            if (!value) {
                return '—';
            }
            const date = new Date(value);
            if (isNaN(date.getTime())) {
                return value;
            }
            return date.toLocaleString();
        }

        function renderStatus(data) {
            document.getElementById('worker-thread').textContent = data.worker_thread_running ? 'Running' : 'Stopped';
            document.getElementById('cycle-status').textContent = data.worker_running ? 'Processing' : 'Idle';
            document.getElementById('last-start').textContent = toDisplayTime(data.last_run_start);
            document.getElementById('last-finish').textContent = toDisplayTime(data.last_run_finish);
            document.getElementById('processed-total').textContent = data.processed_total || 0;
            document.getElementById('poll-interval').textContent = data.poll_interval_seconds || 0;
            document.getElementById('last-error').textContent = data.last_error || 'None';
            renderEvents(data.events || []);
        }

        function renderEmails(emails) {
            const tbody = document.getElementById('emails-body');
            tbody.innerHTML = '';
            emails.forEach((item) => {
                const row = document.createElement('tr');
                row.className = 'email-row';
                row.dataset.emailId = item.id;
                const classification = item.is_spam ? '<span class="badge-spam">Spam</span>' : '<span class="badge-ham">Ham</span>';
                row.innerHTML = `
                    <td>${escapeHtml(item.subject || '(no subject)')}</td>
                    <td>${escapeHtml(item.from_email || '')}</td>
                    <td>${escapeHtml(item.to_email || '')}</td>
                    <td>${escapeHtml(item.date || '')}</td>
                    <td>${classification}</td>
                `;
                row.addEventListener('click', () => openEmailModal(item.id));
                tbody.appendChild(row);
            });
        }

        function renderEvents(events) {
            const list = document.getElementById('event-list');
            list.innerHTML = '';
            events.slice(0, 10).forEach((event) => {
                const item = document.createElement('li');
                item.className = `event-item level-${event.level}`;
                item.innerHTML = `
                    <span class="time">${escapeHtml(toDisplayTime(event.timestamp))}</span>
                    <span class="level">${escapeHtml(event.level ? event.level.toUpperCase() : '')}</span>
                    <span class="message">${escapeHtml(event.message || '')}</span>
                `;
                list.appendChild(item);
            });
        }

        function refreshData() {
            fetch(statusEndpoint)
                .then((response) => response.json())
                .then((data) => renderStatus(data))
                .catch(() => {});
            fetch(`${emailsEndpoint}?limit=25`)
                .then((response) => response.json())
                .then((data) => renderEmails(data))
                .catch(() => {});
        }

        function setupProviderSections() {
            const select = document.getElementById('llm_provider');
            if (!select) {
                return;
            }
            const toggleSections = () => {
                document.querySelectorAll('.provider-section').forEach((section) => {
                    section.classList.toggle('d-none', section.dataset.provider !== select.value);
                });
            };
            select.addEventListener('change', toggleSections);
            toggleSections();
        }

        renderStatus(statusState);
        renderEmails(emailsState);
        renderEvents(statusState.events || []);
        setupProviderSections();
        setInterval(refreshData, 5000);

        function setDetailField(id, value, allowHtml = false) {
            const el = document.getElementById(id);
            if (!el) {
                return;
            }
            if (allowHtml) {
                el.innerHTML = value;
            } else {
                el.textContent = value;
            }
        }

        function classifyBadge(isSpam) {
            const label = isSpam ? 'Spam' : 'Ham';
            const cls = isSpam ? 'badge-spam' : 'badge-ham';
            return `<span class="${cls}">${label}</span>`;
        }

        function openEmailModal(emailId) {
            setDetailField('detailSubject', 'Loading...');
            setDetailField('detailFrom', 'Loading...');
            setDetailField('detailTo', 'Loading...');
            setDetailField('detailDate', 'Loading...');
            setDetailField('detailClassification', 'Loading...');
            setDetailField('detailId', escapeHtml(emailId));
            document.getElementById('detailBody').textContent = 'Loading email body...';
            $('#emailModal').modal('show');
            fetch(`${emailsEndpoint}/${encodeURIComponent(emailId)}`)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Unable to load email detail');
                    }
                    return response.json();
                })
                .then((data) => {
                    setDetailField('detailSubject', data.subject || '(no subject)');
                    setDetailField('detailFrom', data.from_email || '');
                    setDetailField('detailTo', data.to_email || '');
                    setDetailField('detailDate', data.date || '');
                    setDetailField('detailClassification', classifyBadge(Boolean(data.is_spam)), true);
                    setDetailField('detailId', data.id || emailId);
                    const body = data.plain_text_body || data.html_body || '(no body)';
                    document.getElementById('detailBody').textContent = body;
                })
                .catch(() => {
                    document.getElementById('detailBody').textContent = 'Unable to load email details.';
                    setDetailField('detailClassification', '<span class="text-danger">Error</span>', true);
                });
        }
    </script>
</body>
</html>
